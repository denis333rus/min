{% extends "base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—á–Ω—ã–º —Å–æ—Å—Ç–∞–≤–æ–º{% endblock %}

{% block extra_css %}
<style>
.admin-section { padding: 40px 0; }
.grid { display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
@media (max-width: 1000px){ .grid { grid-template-columns: 1fr; } }
.card { background:#fff; border-radius:12px; padding:20px; box-shadow:0 8px 24px rgba(0,0,0,0.06); }
.card h2 { margin:0 0 12px 0; }
.row { display:flex; gap:8px; margin-bottom:8px; }
.row input, .row select { flex:1; padding:10px; border:1px solid #ddd; border-radius:8px; }
.row button { padding:10px 14px; border:none; border-radius:8px; background:#1a1a1a; color:#fff; cursor:pointer; }
.row button:hover { background:#333; }
.list { margin-top:10px; }
.item { padding:8px 10px; border:1px solid #eee; border-radius:8px; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center; }
.muted { color:#777; }
.users-card .row { align-items: center; }
.rank { min-width: 160px; }
</style>
{% endblock %}

{% block content %}
<section class="admin-section">
  <div class="admin-container">
    <h1>üõ°Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—á–Ω—ã–º —Å–æ—Å—Ç–∞–≤–æ–º</h1>
    <div class="grid">
      <div class="card users-card">
        <h2>–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
        <div class="row">
          <input id="users-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ª–æ–≥–∏–Ω—É...">
          <button onclick="loadUsers()">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div id="users" class="list"></div>
      </div>
      <div class="card">
        <h2>–ì—Ä—É–ø–ø—ã</h2>
        <div class="row">
          <input id="group-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
          <input id="group-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
          <button onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
        <div id="groups" class="list"></div>
      </div>

      <div class="card">
        <h2>–°–æ—Å—Ç–∞–≤ –≥—Ä—É–ø–ø—ã</h2>
        <div class="row">
          <select id="group-select"></select>
          <input id="member-username" placeholder="–õ–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
          <button onclick="addMember()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div id="members" class="list"></div>
      </div>

      <div class="card">
        <h2>–í—ã–¥–∞—Ç—å –±–æ–µ–≤—É—é –∑–∞–¥–∞—á—É</h2>
        <div class="row">
          <input id="task-title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
          <input id="task-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
        </div>
        <div class="row">
          <input id="task-due" placeholder="–°—Ä–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 2025-11-01)">
          <select id="task-priority">
            <option value="normal">–û–±—ã—á–Ω—ã–π</option>
            <option value="high">–í—ã—Å–æ–∫–∏–π</option>
            <option value="low">–ù–∏–∑–∫–∏–π</option>
          </select>
        </div>
        <div class="row">
          <input id="task-username" placeholder="–õ–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–ª–∏ –ø—É—Å—Ç–æ)">
          <select id="task-group"></select>
          <button onclick="sendTask()">–í—ã–¥–∞—Ç—å</button>
        </div>
        <div class="muted">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ª–∏–±–æ –ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ª–∏–±–æ –≤—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É.</div>
      </div>

      <div class="card">
        <h2>–í—ã–¥–∞—Ç—å –ø–æ—Ä—É—á–µ–Ω–∏–µ</h2>
        <div class="row">
          <input id="assign-title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
          <input id="assign-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
        </div>
        <div class="row">
          <input id="assign-issued" placeholder="–ö–µ–º –≤—ã–¥–∞–Ω–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
        </div>
        <div class="row">
          <input id="assign-username" placeholder="–õ–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–ª–∏ –ø—É—Å—Ç–æ)">
          <select id="assign-group"></select>
          <button onclick="sendAssignment()">–í—ã–¥–∞—Ç—å</button>
        </div>
      </div>

      <div class="card">
        <h2>–†–∞—Å–ø–æ—Ä—è–¥–æ–∫ –¥–Ω—è</h2>
        <div class="row">
          <input id="sch-day" placeholder="–î–µ–Ω—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: Monday)">
          <input id="sch-wake" placeholder="–ü–æ–¥—ä—ë–º">
          <input id="sch-train" placeholder="–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞">
        </div>
        <div class="row">
          <input id="sch-duty" placeholder="–ù–∞—Ä—è–¥">
          <input id="sch-rest" placeholder="–û—Ç–¥—ã—Ö">
          <input id="sch-lights" placeholder="–û—Ç–±–æ–π">
        </div>
        <div class="row">
          <input id="sch-username" placeholder="–õ–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–ª–∏ –ø—É—Å—Ç–æ)">
          <select id="sch-group"></select>
          <button onclick="sendSchedule()">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
async function j(url, method='GET', body){
  const r = await fetch(url, { method, headers: { 'Content-Type':'application/json' }, body: body?JSON.stringify(body):undefined });
  return await r.json();
}

const RANKS = ['–†—è–¥–æ–≤–æ–π','–ï—Ñ—Ä–µ–π—Ç–æ—Ä','–ú–ª–∞–¥—à–∏–π —Å–µ—Ä–∂–∞–Ω—Ç','–°–µ—Ä–∂–∞–Ω—Ç','–°—Ç–∞—Ä—à–∏–π —Å–µ—Ä–∂–∞–Ω—Ç','–ü—Ä–∞–ø–æ—Ä—â–∏–∫','–ú–ª–∞–¥—à–∏–π –ª–µ–π—Ç–µ–Ω–∞–Ω—Ç','–õ–µ–π—Ç–µ–Ω–∞–Ω—Ç','–°—Ç–∞—Ä—à–∏–π –ª–µ–π—Ç–µ–Ω–∞–Ω—Ç','–ö–∞–ø–∏—Ç–∞–Ω','–ú–∞–π–æ—Ä','–ü–æ–¥–ø–æ–ª–∫–æ–≤–Ω–∏–∫','–ü–æ–ª–∫–æ–≤–Ω–∏–∫','–ì–µ–Ω–µ—Ä–∞–ª'];

async function loadUsers(){
  const data = await j('/api/admin/users');
  const wrap = document.getElementById('users');
  const q = (document.getElementById('users-search').value || '').toLowerCase();
  wrap.innerHTML = '';
  data
    .filter(u => !q || (u.username||'').toLowerCase().includes(q))
    .forEach(u => {
      const row = document.createElement('div'); row.className='item';
      const left = document.createElement('div'); left.innerHTML = `<strong>${u.username}</strong><div class='muted'>ID: ${u.id}</div>`;
      const right = document.createElement('div');
      const select = document.createElement('select'); select.className='rank';
      RANKS.forEach(r => select.add(new Option(r, r, false, (u.rank||'')===r)));
      const save = document.createElement('button'); save.textContent='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'; save.onclick = async ()=>{
        const res = await j(`/api/admin/users/${u.id}`, 'PUT', { rank: select.value });
        if(!res.success) return alert(res.message||'–û—à–∏–±–∫–∞');
        alert('–ó–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
      };
      right.append(select, save);
      row.append(left, right);
      wrap.appendChild(row);
    });
}

async function loadGroups(){
  const data = await j('/api/admin/groups');
  const wrap = document.getElementById('groups');
  wrap.innerHTML = '';
  const sel = document.getElementById('group-select');
  const gSel = [document.getElementById('task-group'), document.getElementById('assign-group'), document.getElementById('sch-group')];
  sel.innerHTML = ''; gSel.forEach(s=> s.innerHTML='');
  data.forEach(g => {
    const row = document.createElement('div'); row.className='item';
    row.innerHTML = `<div><strong>${g.name}</strong><div class='muted'>${g.description||''}</div></div>`;
    const btns = document.createElement('div');
    const edit = document.createElement('button'); edit.textContent='‚úèÔ∏è'; edit.onclick=async()=>{
      const name = prompt('–ù–æ–≤–æ–µ –∏–º—è', g.name); if(!name) return;
      const description = prompt('–û–ø–∏—Å–∞–Ω–∏–µ', g.description||'');
      await j(`/api/admin/groups/${g.id}`, 'PUT', { name, description });
      loadGroups();
    };
    const del = document.createElement('button'); del.textContent='üóëÔ∏è'; del.onclick=async()=>{ if(!confirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?')) return; await j(`/api/admin/groups/${g.id}`, 'DELETE'); loadGroups(); };
    btns.append(edit, del); row.appendChild(btns); wrap.appendChild(row);
    const opt = new Option(g.name, g.id); sel.add(opt.cloneNode(true)); gSel.forEach(s=> s.add(new Option(g.name, g.id)));
  });
  loadMembers();
}

async function loadMembers(){
  const gid = document.getElementById('group-select').value; if(!gid) { document.getElementById('members').innerHTML=''; return; }
  const data = await j(`/api/admin/groups/${gid}/members`);
  const wrap = document.getElementById('members'); wrap.innerHTML='';
  data.forEach(m=>{
    const row = document.createElement('div'); row.className='item';
    row.innerHTML = `<div>${m.username}</div>`;
    const del = document.createElement('button'); del.textContent='üóëÔ∏è'; del.onclick=async()=>{ await j(`/api/admin/groups/${gid}/members/${m.user_id}`, 'DELETE'); loadMembers(); };
    row.appendChild(del); wrap.appendChild(row);
  });
}

async function createGroup(){
  const name = document.getElementById('group-name').value.trim();
  const description = document.getElementById('group-desc').value.trim();
  if(!name) return alert('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
  const res = await j('/api/admin/groups', 'POST', { name, description });
  if(!res.success) return alert(res.message||'–û—à–∏–±–∫–∞');
  document.getElementById('group-name').value=''; document.getElementById('group-desc').value='';
  loadGroups();
}

async function addMember(){
  const gid = document.getElementById('group-select').value; if(!gid) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É');
  const username = document.getElementById('member-username').value.trim(); if(!username) return alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω');
  const res = await j(`/api/admin/groups/${gid}/members`, 'POST', { username });
  if(!res.success) return alert(res.message||'–û—à–∏–±–∫–∞');
  document.getElementById('member-username').value='';
  loadMembers();
}

function targetIds(userInputId, groupSelectId){
  const username = document.getElementById(userInputId).value.trim();
  const gid = document.getElementById(groupSelectId).value;
  return { username, gid };
}

async function resolveUserId(username){
  if(!username) return null;
  const users = await j('/api/admin/users');
  const u = users.find(x=> x.username === username);
  return u ? u.id : null;
}

async function sendTask(){
  const { username, gid } = targetIds('task-username', 'task-group');
  const title = document.getElementById('task-title').value.trim();
  if(!title) return alert('–£–∫–∞–∂–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫');
  const body = {
    title,
    description: document.getElementById('task-desc').value.trim(),
    due_date: document.getElementById('task-due').value.trim(),
    priority: document.getElementById('task-priority').value
  };
  if (username) body.user_id = await resolveUserId(username); else if (gid) body.group_id = Number(gid);
  const res = await j('/api/admin/actions/task', 'POST', body);
  if(!res.success) return alert(res.message||'–û—à–∏–±–∫–∞');
  alert(`–°–æ–∑–¥–∞–Ω–æ –¥–ª—è: ${res.created_for}`);
}

async function sendAssignment(){
  const { username, gid } = targetIds('assign-username', 'assign-group');
  const title = document.getElementById('assign-title').value.trim(); if(!title) return alert('–£–∫–∞–∂–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫');
  const body = { title, description: document.getElementById('assign-desc').value.trim(), issued_by: document.getElementById('assign-issued').value.trim() };
  if (username) body.user_id = await resolveUserId(username); else if (gid) body.group_id = Number(gid);
  const res = await j('/api/admin/actions/assignment', 'POST', body);
  if(!res.success) return alert(res.message||'–û—à–∏–±–∫–∞');
  alert(`–°–æ–∑–¥–∞–Ω–æ –¥–ª—è: ${res.created_for}`);
}

async function sendSchedule(){
  const { username, gid } = targetIds('sch-username', 'sch-group');
  const day = document.getElementById('sch-day').value.trim(); if(!day) return alert('–£–∫–∞–∂–∏—Ç–µ –¥–µ–Ω—å');
  const body = {
    day,
    wake_up: document.getElementById('sch-wake').value.trim(),
    training: document.getElementById('sch-train').value.trim(),
    duty: document.getElementById('sch-duty').value.trim(),
    rest: document.getElementById('sch-rest').value.trim(),
    lights_out: document.getElementById('sch-lights').value.trim()
  };
  if (username) body.user_id = await resolveUserId(username); else if (gid) body.group_id = Number(gid);
  const res = await j('/api/admin/actions/schedule', 'POST', body);
  if(!res.success) return alert(res.message||'–û—à–∏–±–∫–∞');
  alert(`–°–æ–∑–¥–∞–Ω–æ –¥–ª—è: ${res.created_for}`);
}

document.addEventListener('DOMContentLoaded', () => {
  loadGroups();
  document.getElementById('group-select').addEventListener('change', loadMembers);
  loadUsers();
  const us = document.getElementById('users-search'); if (us) us.addEventListener('input', loadUsers);
});
</script>
{% endblock %}


